<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | youniaogu</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://youniaogu.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://youniaogu.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://youniaogu.github.io/blog"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | youniaogu"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/takodachi-eat-cookies.gif"><link data-rh="true" rel="canonical" href="https://youniaogu.github.io/blog"><link data-rh="true" rel="alternate" href="https://youniaogu.github.io/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://youniaogu.github.io/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="youniaogu RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="youniaogu Atom Feed"><link rel="stylesheet" href="/assets/css/styles.7620b946.css">
<link rel="preload" href="/assets/js/runtime~main.7de11c5b.js" as="script">
<link rel="preload" href="/assets/js/main.501984e4.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/takodachi-eat-cookies.gif" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/takodachi-eat-cookies.gif" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">youniaogu</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有的文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/11/15/记一次内存泄漏问题">记一次内存泄漏问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/10/17/2023年末回顾">2023年末回顾</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/07/console_log_what_a_lier">说谎的 console.log</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/03/09/how_to_handle_lock_file">如何处理 package-lock.json 与 yarn.lock</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/09/03/experience_of_build_wechat_miniapp">小程序开发经验分享</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/06/25/better_linear_gradient_background">更好的线性渐变背景</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/02/18/what_is_redux-toolkit">什么是 redux-toolkit</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/12/21/learn_about_class_through_babel">通过 babel 看 class</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/11/16/record_a_question_of_react">记一个 react 问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/11/09/practice_experience_of_typescript">typescript 实践心得</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/10/15/virtual_list">虚拟列表</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/10/10/floating_point_calculation_problem">浮点数计算问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/10/10/tasks_and_microtasks">宏任务和微任务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/22/grid_layout">网格布局</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/21/debounce_and_throttle">防抖和节流</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/21/interview_questions">面试题汇总</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/16/the_simple_react-router-dom">react-router-dom 简单讲解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/14/version_of_fontend_project">前端版本号定义</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/09/cancel_fetch_in_redux-saga">redux-saga 中取消 fetch 请求</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/09/02/why_fetch">为什么用 fetch？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/08/28/how_to_limit_in_react_input">input 限制输入</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/07/20/how_to_implement_redux">如何实现 Redux</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/06/30/what_is_reselect">什么是 Reselect</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/06/27/function_return_function">返回函数的函数</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/06/27/how_to_definition_action_type">如何定义 Action type</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/06/27/how_to_implement_react-redux">如何实现 React-redux</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/11/15/记一次内存泄漏问题">记一次内存泄漏问题</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-15T00:00:00.000Z" itemprop="datePublished">2023年11月15日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>这篇文章主要是记录我第一次在 <strong>React-Native</strong> 上遇到的内存泄露问题，以及我是<strong>如何复现、定位和解决</strong>的</p><p>这个问题是一个网友发现的，他在 Github 上提了个 <strong><a href="https://github.com/youniaogu/MangaReader/issues/72" target="_blank" rel="noopener noreferrer">issues</a></strong>，说自己使用<strong>批量更新</strong>在 200 本漫画更新至 130 本左右时<strong>应用闪退</strong>，并出现下面这些报错</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MangaReader[34387:6766278] [javascript] ┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W1105 14:09:47.729962 1810935808 JSIExecutor.cpp:378] Memory warning (pressure level: 1) received by JS VM, unrecognized pressure level</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到这个警告是在说<strong>应用内存占用过高</strong>，结合他说的应用闪退，很可能是因为<strong>内存泄露导致内存占用太高，最后进程被系统强制关闭</strong></p><p>在初步确认问题后，要开始想办法复现问题</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="复现问题">复现问题<a href="#复现问题" class="hash-link" aria-label="复现问题的直接链接" title="复现问题的直接链接">​</a></h3><p>他在 v0.6.3 版本遇到这个问题，更新至 v0.6.6（最新版）问题依旧存在，然后使用的是平板并且是 ipados v16.3.1</p><p>我没有平板，模拟器和手机都还是 ios v15，所以有可能无法复现</p><p>开始我用自己添加的 420 本漫画进行测试，<strong>没有遇到闪退</strong>，怀疑可能测试数据不对，于是找网友要备份数据，但也没能复现</p><p><img loading="lazy" src="data:image/png;base64,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" width="240" height="66" class="img_ev3q"></p><p>图片有点模糊，但从最左边的 <strong>RAM</strong> 可以看到，更新完后内存稳定在 <strong>500M</strong> 左右，没有遇到闪退的问题（<strong>这里虽然没有闪退，但已经存在内存泄露，只不过运气好没溢出而已，后面会解释</strong>）</p><p><img loading="lazy" src="/assets/images/46-4d5b3b40369fe92903a160eea099d9fb.png" width="810" height="157" class="img_ev3q"></p><p>然后网友提供的视频录制里可以看到 RAM 已经去到了 <strong>1600M</strong>，下一秒应用进程就被杀死然后闪退</p><p>没能复现，我开始怀疑是不是 OS 问题，于是我去谷歌搜索相关内容，我甚至还检查了备份数据内容，但都没能发现有用的信息</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="定位问题">定位问题<a href="#定位问题" class="hash-link" aria-label="定位问题的直接链接" title="定位问题的直接链接">​</a></h3><p>虽然没能复现问题，但我很确定这是内存泄露，所以我决定<strong>跳过问题复现</strong>，直接<strong>检测内存泄露</strong>，用的工具是 Xcode 的 Instruments</p><p>下面是我第一次的<strong>内存泄露</strong>和<strong>内存分配</strong>的检测截图</p><p><img loading="lazy" src="/assets/images/47-908a1b43c3817f85c994ae953a050003.png" width="1746" height="767" class="img_ev3q"></p><p>可以看到内存占用一直在增加，从最开始的 <strong>50M 飙到了 500M</strong>，中间有内存回收的迹象，但总体是在上升的，是<strong>很明显的内存泄露</strong>，<strong>但 Leaks 却没有提示</strong></p><p><img loading="lazy" src="/assets/images/48-703b0d1252820fa28b8c8c888c5e3925.png" width="1466" height="854" class="img_ev3q"></p><p>既然 Leaks 没能检测出泄露，那么我只能自己在<strong>内存分配里查找线索</strong>，<strong>注意蓝色的用户图标，它代表这部分是我们创建的代码</strong></p><p><img loading="lazy" src="/assets/images/50-37ff245336229b5d05f4415cd2543d5c.png" width="1173" height="474" class="img_ev3q"></p><p>注意横线部分关键字，bridge 应该是指负责 native 和 js 通信的部分，const 是 js 定义变量关键字，表明我们定义了一个 <strong>517M</strong> 的变量通过 bridge 传给了 native</p><p><img loading="lazy" src="/assets/images/49-81a25d4cef5ff862e906dee971ab134c.png" width="659" height="501" class="img_ev3q"></p><p>右下角里可以看到有 dynamic const 的关键字，这很可能是在说我们定义了一个 <strong>447M</strong> 的变量，并且这个变量一直没有回收</p><p>最后综合分析一下，在批量更新过程中，我们定义了一个很大的变量交给 native，这个变量没有回收导致内存泄露，再结合代码中的业务逻辑，可以发现问题出在<strong>数据同步</strong>上面</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决问题">解决问题<a href="#解决问题" class="hash-link" aria-label="解决问题的直接链接" title="解决问题的直接链接">​</a></h3><p>接下来说的内容涉及业务相关的，如果不感兴趣可以跳到 <strong><a href="#%E6%80%BB%E7%BB%93">总结</a></strong> 部分</p><p>为什么可以断定是数据同步，因为数据同步符合上面提到的特征</p><ul><li>批量更新会加载漫画详情数据，<strong>加载完成后会触发数据同步</strong></li><li>数据同步会处理 Redux 里的数据，所以会<strong>定义很大的变量</strong></li><li>数据同步会把这些数据<strong>传给 native 并存在本地</strong></li></ul><p>接下来要<strong>确认和定位问题</strong>，方法很简单，用<strong>排除法</strong>把相关代码注释再去看内存分配情况</p><p>下面是注释<strong>数据同步</strong>后的<strong>内存分配检测截图</strong></p><p><img loading="lazy" src="/assets/images/51-dabcc0b617148277391cdfe6a25d0fa1.png" width="1920" height="980" class="img_ev3q"></p><p>可以看到<strong>内存变化很平稳</strong>，虽然内存一直在增大，但内存最高只有 <strong>170M</strong>，同时有内存回收迹象</p><p>右下角也看不到上一个测试里的大变量，很显然<strong>问题就出数据同步</strong></p><p>接下来我们需要再进一步的<strong>定位到具体代码</strong>，这一步我是<strong>基于业务和主观猜测</strong>找出来了</p><p>我重构了数据同步，并<strong>删除了数据同步的打断逻辑</strong>，因为我觉得<strong>频繁打断数据同步</strong>会造成任务中定义的<strong>备份数据内存泄露</strong></p><p>然后下面是<strong>最终的内存分配检测截图</strong></p><p><img loading="lazy" src="/assets/images/52-61bb318cd2108f28114322278619b954.png" width="2880" height="1056" class="img_ev3q"></p><p>我们可以看到<strong>一座座美丽的内存回收小山</strong>！</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3><p>至此内存泄露问题已经解决，但这过程中我也犯了一些<strong>小错误</strong></p><p>其中我因为缺乏内存泄露的处理经验，<strong>错误判断了复现结果</strong></p><p>最开始尝试复现的时候，我想复现应用闪退（内存溢出导致进程被杀死），但实际上只要不是<strong>长时间运行</strong>或者<strong>重复大量操作</strong>，<strong>内存泄露不一定会导致内存溢出</strong></p><p>所以第一次复现时已经成功了，只不过我的<strong>关注点错了</strong>，以至于后面我的关注点偏到备份数据和 OS 上面</p><p>最后还有个<strong>小疑问</strong>，为什么<strong>同样的备份数据</strong>，网友会<strong>内存溢出闪退</strong>，而我却不会？</p><p>事实上是因为<strong>网速不同</strong>！</p><p>这些内存泄露的<strong>直接原因</strong>是数据同步被<strong>打断</strong>，导致中间生成的备份数据没法被释放，所以<strong>越频繁的打断数据同步</strong>，造成<strong>内存泄露量就越大</strong>！</p><p>而我用的<strong>代理比较差</strong>，漫画<strong>加载速度比较慢</strong>，数据同步任务<strong>被打断次数较少</strong>，所以<strong>内存泄露量也较少</strong>，最终结果就是同样的备份数据，我这边复现操作不会闪退</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/react-naitve">React-Naitve</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/manga-reader">MangaReader</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/bug">Bug</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2023/10/17/2023年末回顾">2023年末回顾</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-17T00:00:00.000Z" itemprop="datePublished">2023年10月17日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>上次写文章还是在 <a href="/blog/2022/04/07/console_log_what_a_lier">22 年 4 月</a>，中间没有写并不是因为弃坑，而是我找到了想做的事</p><p>所以这次就来回顾下，过去这段时间里我做了哪些事情</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="app-开发">App 开发<a href="#app-开发" class="hash-link" aria-label="App 开发的直接链接" title="App 开发的直接链接">​</a></h3><p>2022 年初开始，我一直致力于开发和维护 <a href="https://github.com/youniaogu/MangaReader" target="_blank" rel="noopener noreferrer">MangaReader</a> 项目，从最开始的 v0.1.0，到现在最新的 v0.6.5，一共发布了 39 个版本，处理了 60+ 个 issues，10 个可用插件，完成了一次 React-Native 大版本升级，为相关依赖库贡献 issues 和 pr。在这期间，网友们也提出了很多不错的功能建议以及 bug 反馈，真的非常感谢 🙏</p><p>这是我的第二个 React-Native 项目，第一个也是类似的<a href="https://github.com/youniaogu/rn-dmzj" target="_blank" rel="noopener noreferrer">漫画 app</a>，可惜的是我没能坚持维护下去，不过正因为有第一次失败的经验，让我更加清楚自己想要的效果是怎么样的</p><p>至于为什么要开发 MangaReader 这个项目，除了<a href="https://github.com/youniaogu/MangaReader#%E5%85%B3%E4%BA%8E-app" target="_blank" rel="noopener noreferrer">readme</a>上说的兴趣使然外，根本原因是 ios 上没有满足我需求的 app，以及我想积累自己的跨平台开发经验</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="备考-n1">备考 N1<a href="#备考-n1" class="hash-link" aria-label="备考 N1的直接链接" title="备考 N1的直接链接">​</a></h3><p>有这个想法是在 2023 年初的时候，真正开始备考则是从 2023 年 3 月说起，每天上下班路上背单词并看一到两篇 NHK 新闻，午休或空闲时间会看下日本新闻或节目（月曜日 👍），都是三十分钟以内的视频，晚上到家上网课学习、做阅读理解（有时候会维护开源项目），周六日类似不过会稍微放松些，睡个懒觉看看番自己做饭之类的</p><p>报考的是 12 月初的考试，距离考试只有 33 天工作日，6 个双休日。在这期间我要完成 45 节网课，10 套模拟真题，并预留一个星期时间做考前冲刺。因为工作的原因，我的空闲时间都压在了周六日，所以不能再想之前一样悠闲，要开始绷紧神经认真应对</p><p>为什么要考 N1，一方面是我对日本文化非常感兴趣，高中时就自学过一段时间的日语，高三报考志愿第一个填的就是日语专业(虽然最后落选了，不过也因祸得福，要是当时进了日语专业，我现在可能连饭都吃不起)，并且大三时自学通过了 N3 入门考试，所以我心里一直有个念头要考过 N1</p><p>还有一方面是想提高个人竞争力，出来工作这么多年，越来越觉得，会一门外语真的很有优势。不过我的目标并不只是 N1 证书，我更希望能熟练运用日语，拒绝哑巴日语。就算 12 月的考试通过了，我也会继续背单词看书看新闻看节目还有口语练习</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="博客迁移">博客迁移<a href="#博客迁移" class="hash-link" aria-label="博客迁移的直接链接" title="博客迁移的直接链接">​</a></h3><p>博客目前经历了三个版本，第一版部署在 github pages，使用<a href="https://github.com/GitbookIO/gitbook" target="_blank" rel="noopener noreferrer">gitbook</a>打包，<a href="https://github.com/tschaub/gh-pages" target="_blank" rel="noopener noreferrer">gh-pages</a>发布，功能简单样式好看，但打包和发布工具已经不维护，经常会出现发布失败或打包失败的情况，非常头疼</p><p>第二版放弃自己打包和发布，全部交给<a href="https://www.gitbook.com/" target="_blank" rel="noopener noreferrer">gitbook 平台</a>处理，维护是轻松了，但不开通会员功能有限，更最重要的是域名不能自己更改，随机的地址很丑 👎</p><p>第三版回归 github pages，打包和发布用<a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer">docusaurus</a>，aio 结构并且自由度高，基于 react 开发，随时都可以对它进行 diy，默认样式也很好看，自带一键打包发布，而且社区正在积极维护中。迁移也很方便，一个晚上的时间就搞好了，只不过目前还没有进行自定义，主题色和首页还是默认的</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3><p>开发和维护 RN 应用有一年半时间，在这期间我也面临着一些老生常谈的问题，web 开发者的局限性以及社区活跃度不足，这两点形成了组合拳，想要突破这些，就必须了解原生开发并具备自己开发 Module 的能力。所以在接下来的时间我要想办法突破这些，做出自己的 React-Native Module 或者为 RN 社区做出贡献</p><p>然后关于语言，其实在 IT 这个领域，英语比日语更有优势（非洲都有人说英语）。选择日语，只是因为对于我来说比较好上手，而且我的最终目的并不只是日语，英语也是其中之一，通过 N1 后我也会开始系统的学习英语包括口语</p><p>再聊下为什么要写博客，我的答案是巩固知识深度，以及锻炼组织表达能力。做技术的过程中我们会遇到很多问题，其中的难点往往不是解决问题，而是归纳总结，将复杂的问题简单化，并清晰的讲解给其他人听，让其他人遇到类似问题也能迎刃而解。在这个归纳总结的过程中你可能会无形间发散这个问题，这样子的话会怎样，那样子的话呢，以及怎么组织语言、怎么开头、怎么结尾、举什么样的例子或者画什么样图，让更多的人理解并深入这个问题，这时候就起到了巩固和锻炼的作用</p><p>最后也祝我 12 月 N1 考试顺利 ，加油！💪</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2022/04/07/console_log_what_a_lier">说谎的 console.log</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-07T00:00:00.000Z" itemprop="datePublished">2022年4月7日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="说谎的-consolelog">说谎的 console.log<a href="#说谎的-consolelog" class="hash-link" aria-label="说谎的 console.log的直接链接" title="说谎的 console.log的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1前言">1、前言<a href="#1前言" class="hash-link" aria-label="1、前言的直接链接" title="1、前言的直接链接">​</a></h4><p><code>console.log</code>，前端在调试时用得最多的小伙伴，但你可能不知道，它有时候也会说谎</p><p>之所以要说这个，原因是最近修 🐛 时，无意中发现<code>console.log</code>断点调试输出与非断点输出不一致</p><img loading="lazy" src="/assets/images/9-a98bba4c5d2486b8e3ccba066f9c4ed5.jpg" width="300" class="img_ev3q"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2为什么-consolelog-输出会不一致">2、为什么 console.log 输出会不一致？<a href="#2为什么-consolelog-输出会不一致" class="hash-link" aria-label="2、为什么 console.log 输出会不一致？的直接链接" title="2、为什么 console.log 输出会不一致？的直接链接">​</a></h4><p>首先，我们要明确一个观念，<code>console.log</code>是同步的还是异步的？</p><p>理论上，<code>console.log</code>是同步的，他们实时输出数据，但在输出引用类型的数据，会有不同的行为</p><img loading="lazy" src="/assets/images/42-70765d7a77ce49f8f8714a96856c2eef.png" width="900" class="img_ev3q"><p>可以看到，引用类型数据如果存在嵌套时（图中红线），log 不会继续输出里面的数据，而是会省略</p><p>而且引用类型还可以<strong>展开</strong>，用来查看里面嵌套的数据，这是我们平时调试常用的动作</p><p>而<code>console.log</code>输出不一致的原因，就在于<strong>展开</strong>这个动作</p><img loading="lazy" src="/assets/images/6-c549fe9904b67e48edfaaa5cec4878b6.png" width="300" class="img_ev3q"><p>之前<code>console.log</code>输出的数据并不完整，只能说是一种快照。而在展开时，则会往堆内存里拿最新的数据，这中间如果有对数据进行修改的话，就会出现异步的假象</p><p>举个 🌰</p><p>下面的代码，立即展开和三秒后展开会有不同的结果</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;start&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;after 3 seconds&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><img loading="lazy" src="/assets/images/43-d8ab1278e4e8920777db847a191c6ba8.png" width="300" class="img_ev3q"><img loading="lazy" src="/assets/images/44-9f3238a0d2f3a8fe96568244e7687d4c.png" width="300" class="img_ev3q"><p>回到最开始的问题，为什么断点和非断点调试，<code>console.log</code>输出会不一致</p><p>答案很明了，代码里存在对输出数据的修改，导致两次调试结果不一致。</p><p>而就结果来看，断点调试的输出才是正确的，也是我们想要的（都断点了，谁还看 log 呀）。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3为什么会这么设计">3、为什么会这么设计？<a href="#3为什么会这么设计" class="hash-link" aria-label="3、为什么会这么设计？的直接链接" title="3、为什么会这么设计？的直接链接">​</a></h4><p>主要原因在于引用类型会存在<strong>循环引用</strong>的情况，一次性打印出来的话就会死循环，而如果缓存数据，则会占用资源</p><p>注意：以上测试与结论都基于 chrome 浏览器，不同浏览器实现可能不一样</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4总结">4、总结<a href="#4总结" class="hash-link" aria-label="4、总结的直接链接" title="4、总结的直接链接">​</a></h4><p><code>console.log</code>在打印引用类型时，会立马输出当前的快照，并会省略嵌套的引用类型数据。而后面<strong>展开</strong>数据时，会往堆里拿取最新数据，同时也会缓存起来（后续开关不会更新数据）</p><p>并不只是<code>console.log</code>有这个特性，只要是涉及<strong>展开</strong>这个动作，就会存在</p><img loading="lazy" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4QDKRXhpZgAATU0AKgAAAAgABgESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgEoAAMAAAABAAIAAAITAAMAAAABAAEAAIdpAAQAAAABAAAAZgAAAAAAAABIAAAAAQAAAEgAAAABAAeQAAAHAAAABDAyMjGRAQAHAAAABAECAwCgAAAHAAAABDAxMDCgAQADAAAAAQABAACgAgAEAAAAAQAAAJugAwAEAAAAAQAAAJ2kBgADAAAAAQAAAAAAAAAAAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wgARCACdAJsDASIAAhEBAxEB/8QAHAAAAQQDAQAAAAAAAAAAAAAAAAEEBgcCAwUI/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABr/m4grtm9Lh2bJeV5nYSkQcyRSJMZ4hBOtJuaLDOBXZYnWqVD0h1PNPok80Cg49AwK2gXTsMgAABFQADTRl88c84rs0izuB944y3jAy3n6KV5wrYbnIk8RlBuIvEi0krLnlwLA50ZIoUjBvRXn4a2sxtgac/iTc25Y5EGiNzYkWlTR2cvDPnDp7ENJK+jH+0PQAr2wq9LAxzQryxK0ssyAF17G5vRUGbzmtTuigAGIoY17YddliJy+oQua0ReplliovJSKne359A4nNkcbJsuraAAioCQSdVuQm9/MU5IRd1HOD03nV9mGqOS1CP7eXzB9xpjuGsi1bQRcAQ0myh+pAhNmoFACZQ1T0DIfL3aPRWFadgm5CtBPMYAwLP5tQREt+vo4gYgIKHp8cA3VyDUdBF+I9jZP2TrnGjtcyRGY6BqrkGw5BsOQAAADHJCCO5cpFGk2Qg/f7KmQAAAAAB/8QAKxAAAQQBBAIBAwMFAAAAAAAAAwECBAUABhARExIgFBUhMBYiMSMzNDVA/9oACAEBAAEFAp8t8w+0Y745Y1/HeB86yJjx3UhR6eR+NoIGfRIHDqKHjaRwcES3jq23AmPlhYCXqYDM/VMjyjanY5IthHkpz6RY5ZRqOobDB+CXDDJZb1coAd4ch0aRGMw0faOEkgtRFSPD/E9vLb+udEkbwpT2xdtKwyO2e9rMRefxWsZJMEjVGTaM1VC9PFw2q98ILQRcsqybKk/Kn076u3DNbv5JiPavrqiEgJe1dXr8K0pgS201cRtvs8jGYTokNLRxVcJFaO3LKbj4VvySttFayHZx3wbI7CJ997iK2TBEJ5CVNAR72ta1ss6Rg1Qf6W1vUllOg1kpJUY7xHxz0dMlWUeM9lrEIqSwLh0CXBO5bsuUqMBZ7ajf2FEzrH6KBvniR+JNhUimOj6faIr6IncGvIJoGOb6TV6dS7QuZl76Od47L/Cl8MT7p7Ll8nXZJ/GaSYRU9P2k3lg7GVsnzb7Lmrmr01spsqLmlHtWr9JQWqOPId4mOdmLKKRseMb5Psuat/waWyfDOwjSM05OWNM3tZKxYdWnzBihgHnW3xULkwliSJIE9CM9VzVpuAZEunijMcrHUlu2YL77SQtkB+jMa2LWoFpgkCJ8+UPDvWU2j7Eh+rl8W6hnfNmbhK8JK/UiKgntKzacOaNw5c52QvIjTReVY3xbvzhSMEO2viHcq+1VdlhJDuI0lqORdvBvpznOSZ0eO2VqaMxLO2PO/DzwsazkgyHqZngzUkFcdqSCmLqeHi6pi4XVTMl6hlHQhHEX26RZ0izoDnQLOgWdAslGWO8Nj5lh8HZ8yKrocv8AZEfGlp0CzoFnQLOgWdAs6BZ0izpF76jXhzjs8KT/AFMj+8Fy/WANEn5lybGe+SauP0U8dw2mHGUiVLhDq2j6/wDs/8QAFBEBAAAAAAAAAAAAAAAAAAAAYP/aAAgBAwEBPwFJ/8QAFBEBAAAAAAAAAAAAAAAAAAAAYP/aAAgBAgEBPwFJ/8QANxAAAQMCAgcHAQYHAAAAAAAAAQACAxESBCEQEyAiMTNRIzAyQWGBknEUJEJSkaEFQFNicrHR/9oACAEBAAY/AjI/9NIfGaUQJrrulF93wQDerit6yIehVcTiZHu+qzjquStwFv0VcPi5R6FdrCyZnUcUG4msMnRy1xeNX1REDS89VyY1TERW/RdlID6bIjhbc4qszWmY/t3JErA6vmjqXOfhxxb02GyNPBRyVG8K6RHE2558lGHRtZLbvd2RQUPFOe1tInHLYjF2nXcGh1QT56N4gLLupY6VNMk5ruI0tRB4prRxJoo42igDdDna3c/CFbKLmeq42Sfl2OIWRB2TKwbj9MVeNE5zW2y+iDZW5R6d5zQrX2PHRXwgxuGeSAcakeaDcMg4S8fVc2vurs/ZCPFA55V2JG0zpUKxjC53RCTGNtaPJAAZBPldwCMx8UuekvbJn5Bdpc231WrdvDroDVbK6hVGyLKRqq0i7ZxULm75NwOnD4VnikOaa3oNkO0X9VcTQq/WK5suS8dVnsQFuV4z0yyP4R8NnPTn3ODl9aaZpnA0cePcG3IoxvO+3uInj8Lqpj2nOmegAHMHZ8dhCIvDqLwghbrFraU7iqaC7sic0HNNQU1h8Dth8jRUovmmOfkt0/uqeS3VZIKhBw89vV9dDGZ7oog5vEJsb8ph++l0b+BVI3lqIMrnLsnElZsRLm7ypJ12iXcAjb4G5DYD4zRwTWYlu9+ZB8Zq0+em6F1R0VHBdqFuBAbJfIaNCfHh92Lh9dsMdvx9E2x1CfI+SyNdHAbVZJWhdg0yFUcbY/yjuckLX8FTFMN3VqzL2+yyLz7LwyfosopCtyA19SiG0aCqvNdvls+K5bPiuUz4rls+K5TPiuWz4o/cYizycZGNqpwcJh7Wmg7VgRdJhI4+mbXV/RPDcNI611pLYKiqd9pwUl1xtLYOLU8xxUsda4OZShXKj+K5bPiuWz4rlR/FctnxXKZ8VymfFctnx28DWlNYeNOnrkjmzh/Uh/4sL/gFqYwYmOdcJoXjJ39wR1k7XWYcAmtATXon6kN3jV1vXv6RHGSytNwNwaxvuuyxEzn+bS+g/wBIh32qOwW6uVwLfZOjw/8AC9a+tC5zLWj3V7YcLLKTc9rmUH0b0TjHhThjXebSmf8AO//EACUQAQACAQMEAgMBAQAAAAAAAAEAESEQMUEgUWHxgZEwcaGx0f/aAAgBAQABPyHbMXHZLlx/qVvmbflVeUd8K3cxCvnamU+34QRkfdZsqfccNu8qLXU2SyAQJyw33QKo0o3FlM45bTjUdrZbE+ZJ3H2lTd6FH9lx+4QeVrvFVrWjrRvlWMy8krt6FUq2fMMGJ1OewQSlyAgyv4Ll6Fe2AT66iNVhFZRX9iZlSoY1wfz9aCCa92AbVnf8SIOZbvDCp6SOiEef9jCkGEZstoShUWNAwKuR2gDdsG4+JRkBunoQ3+yYBzw9NLbM131Q5RXqoY7cvlFMCWw20Up3yzKT+VMEqal+ZSsleURwVN4pJe44RLYUXg/NccH2KRAE2dUXf7gnhqoiGmXfmVJgom337d2c3r8YcBohYEQWPyi+KuyhLR2BA85XTcTpT+5WojNkI64joLKYVuFUaPyY/pCHxUasS4mhk0Z73SW1R3UAbR+CfFzZx9mB1DotQs3U+WoySdePSQNUSrlMR79LDQ4PEsi+NGON05YdDZ4NGXJUZm5NV++vZC7PYgeLChw6Zd1s6WVLIEd4W7OUFsi8UJvpncNut8oZW1J+srnOxm4A0kGwdaOjtMu7OzDnJeWF6SMEwJQKrVzYPF9TxBs9kY67dxH4prGKgVxgeUNEL4m1YjPJOXaXEF3gedO9R5BuGENuML6GMHDguf8AVchAa30ZDtElMsYrtBsksGjtO4N5XD2Y0fsIRoF7widjoe6GFJasfA5HOgvpuJFlM5ElRs9+kq94Dt9UP0asUq3aJKRxc+RPwRZ7SgvWQVipmQ6bBhwwOCf2wgv4UkeyQAyXxKM47J3EVoXliSun1aerT1KevT1qerQD4j6oMdSlHCxnLvntKAntCe9wAPswoblygS5Q1wMK9YJoOKnZ+hPRp6NPQJ6NPQp6lPVusneRAb+f9IOxMoDUoHcTYBnwQWEHAq85do2gvlnc/nHrFmjeyP5UJtKUiHJcEkX3YkbwFZoC7yt/iG19sz2Tif2FwomNvCtz8zoHQfh//9oADAMBAAIAAwAAABBBxSAyRSBQgAygAADQiQAiBwQCyQAzSCjhyBRDhjSBQAQDADSTxyRACSQCTQDADzTThTQxwDzBgzSSAzwyTBgTDCwxwABTAQwAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAABg/9oACAEDAQE/EEn/xAAUEQEAAAAAAAAAAAAAAAAAAABg/9oACAECAQE/EEn/xAAnEAEAAgIBAwMEAwEAAAAAAAABABEhMUEQUWFxkfAggbHBMKHR4f/aAAgBAQABPxDDaii6EQmKDoFcQB0OGB7gu9Y7QSorpLHDRqVxqzkCDmWQEWla78dwD3+0q8arZUWlffr2zNSiKEW4bsC/MTCK2zLCOoGn5i49dwJCOzUiohLbYesXUInQhGTfQaDuuDzLtAMHpDMQcEMEOgDtAdpUZliwtjyMucgCxrmqmrIdEVVamh5lMFmPJ1sBOpVytSTPiLyfwmkWyVENYNkGLkAYUCulEOROC+ylCJw9aiwK8hFUi7RcXFFCRbDpl0Hf1VE6cMRnGfAGE8xorLOEm/QzsNv7R2AoFIkN73QWEvM071l9+icDXCj0+0UQe1q+rieudxejz9FXSvuCI+AAYN9Ul5aFLA7/AMm+l+9Ra2qc9o9M2MF/PtFaxZLF1KUoorXQusaDGWBPRX2e0vCMVx4SuKCW4RDgm7iaOVKQbINjvLEFFWol1lmwHux27Cx6XBdG+HkgU0atOYVEFzNG6f6gBhA7ETC6GWzUEvaUuw8d5QoUdEXgpNCzO1lSqa/MxXgI6MNYIeZd1t41PvChU8b8i6SbB/crdoEepbCcLEpgdKqnCuu0s2XKiziUL4ZSoNoKU8Q3CG4OwPqSnAe8G4NEE/cF1BQ1vm5RAoCq/uLXsVDAlxGto4h0SqnGOFOkYqwA0q5lMqMe4TcV3DcNdXxbaIIgmmbK3BI2KjMQC2Cz6mz5bh5mJShP3zFgthlxoS1ajkqG4dWC2115hVY1DcpOEjNXB4Qx4ePrN0g+WLwlxwkJWgp6BUoV3uAENw6MWjAwidCRlorMCVRapuZxC5q5XimEjh8S1L3Wa+oQ2TgAe8TMUDmnNSsuhuRie2ixVrPNwMMbhqUpjRq8vMc3Narj0jw9vJtlLDTGbhC/bvEC4pkqvlxCBMKldVJZKrGZcrk3rMo6jvNkdgtRR5RuElVMQuK8nmXJTULlopTZ5hSX2PMpkC2QQbto9wSdkJ0J/D9TKgQuvGOrqbRtYLmQJm+AgqtzGMILiA/j0UcAoju6DS0d2cfSyJ0zR3Kl1I8iHHFNUENDtNQO5qqnEwsjX3hjowDsiM/LaCWlG0qh38RFVbXnov6Dg7EFHYYPLCO+5crqZ5VxGAsmZO+iENBfYqVnoBvEoSUJzbgLMSlg0IDWApHHl6C39YsosiNROwdoYZtM4DB812Vlvd7q5RfZxL525hLpr9JYjRDUiqnZiV93EIXHQkTr8Z/UH38nxOb5/pD4f+J2B+fafF/1MlQo7iLVKc+0ciNUMvkUWlP5EdjAZIDIBIdOkSWgBWGKAzOZNsU000niKhhVYFSLuk94V4Xz7TL8n2n/AH/858z/AFPjH6n/AFf8YH+n/GfOf1KYGYQ6jnQin+4KPsqCFKRi2Pae45XVsZi5Z0zbxkdYY4O2wKZCBprO/SI886G7GB2gQMRJcuVKlSpX0qgXQ3HKBNhZUdClE+kqCgHoBUXTumqzKQxtAttKBNXiDeMkhy5Y22WyZUxuDW3QHJlllglauHKwzYTGf5hcqYIkqV/E/9k=" width="300" class="img_ev3q"><p>了解这个特性可以让我们 debug 少走弯路，但有一点要明白，最好的 debug 方法还得是<strong>断点</strong></p><p>除此之外，良好的代码习惯也是必不可少的（前言里的问题是因为在 react 里直接修改 state，然后使用 forceUpdate 进行 render 导致，我真是佩服写出这个的老哥）</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2022/03/09/how_to_handle_lock_file">如何处理 package-lock.json 与 yarn.lock</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-03-09T00:00:00.000Z" itemprop="datePublished">2022年3月9日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何处理-package-lockjson-与-yarnlock">如何处理 package-lock.json 与 yarn.lock<a href="#如何处理-package-lockjson-与-yarnlock" class="hash-link" aria-label="如何处理 package-lock.json 与 yarn.lock的直接链接" title="如何处理 package-lock.json 与 yarn.lock的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1前言">1、前言<a href="#1前言" class="hash-link" aria-label="1、前言的直接链接" title="1、前言的直接链接">​</a></h4><p><code>package-lock.json</code>与<code>yarn.lock</code>分别是<code>npm</code>和<code>yarn</code>在安装依赖后自动生成的文件，用来记录安装依赖的具体版本</p><p>每当执行<code>npm install</code>和<code>yarn install</code>都会去创建或更新 lock 文件，将变更提交到 git 后经常会导致 merge，所以有些人会把 lock 文件写进.gitignore 里，<strong>但这个行为是有风险的</strong></p><img loading="lazy" src="/assets/images/1-40b23af1adbf10ab9546a8f5a131bd20.jpg" width="200" class="img_ev3q"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2举个-">2、举个 🌰：<a href="#2举个-" class="hash-link" aria-label="2、举个 🌰：的直接链接" title="2、举个 🌰：的直接链接">​</a></h4><p>你独自负责一个项目，开发了几年，项目稳定，依赖也一直没有出现问题。某天项目扩招，来了个新同事，你十分开心，心想自己可以轻松一些了，但新同事在<code>yarn install</code>后，<strong>提示了好几个警告，项目也跑不起来</strong></p><p>再来一个 🌰：</p><p>一个项目几年没动过，某天领导要求你去开发个小需求。半天不到你就搞定了，本地验证完成，提交代码至 dev，等待 ci 然后验证，心里暗想又可以滑几天水。但你突然发现 ci <strong>没跑过</strong>（又或者是<strong>效果不对</strong>）</p><img loading="lazy" src="/assets/images/6-c549fe9904b67e48edfaaa5cec4878b6.png" width="200" class="img_ev3q"><p>问题在于依赖版本变更，新同事和 ci 上安装的依赖与你本地的依赖版本不同，导致结果有出入</p><p>上面例子出现的可能性低，但这些问题是确实存在的，而且随着时间推移，可能性就越大（本人遇到过第二种情况）</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3那么我们该如何避免这些问题">3、那么我们该如何避免这些问题？<a href="#3那么我们该如何避免这些问题" class="hash-link" aria-label="3、那么我们该如何避免这些问题？的直接链接" title="3、那么我们该如何避免这些问题？的直接链接">​</a></h4><p>简而言之，你需要<strong>锁死依赖版本</strong>，并不是在 package.json 里指定依赖版本，而是让<strong>依赖安装时以 lock 文件为主</strong></p><img loading="lazy" src="data:image/jpeg;base64,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" width="180" class="img_ev3q"><p>首先<strong>保证 lock 文件提交到远程仓库</strong>（lock 文件只能提供信息，并没有锁死版本的功能），然后你需要使用<code>npm ci</code>和<code>yarn install --frozen-lockfile</code><strong>安装依赖</strong>（这些指令会根据 lock 文件安装依赖，当 lock 文件不存在或者 lock 文件与 package.json 有出入时会抛出错误）</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4约束">4、约束：<a href="#4约束" class="hash-link" aria-label="4、约束：的直接链接" title="4、约束：的直接链接">​</a></h4><p>上面说的都是规范，规范如果不被认可不被准守，那就没有意义，所以需要约束</p><ol><li>用 yarn 还是用 npm？</li></ol><p>用哪个都可以，甚至可以两个都用，但需要同时维护<code>package-lock.json</code>与<code>yarn.lock</code>，可以使用<code>yarn import</code>或<a href="https://github.com/imsnif/synp" target="_blank" rel="noopener noreferrer">synp</a>将 lock 文件进行转换，<code>postinstall</code> 里设置好转换的脚本</p><p>不建议同时维护两种，没啥好处，反而增加麻烦，而且混合使用会有警告提示</p><img loading="lazy" src="/assets/images/41-249bd362b48701de5f015d8ef7faf527.png" width="800" class="img_ev3q"><ol start="2"><li>如何让团队成员只用 yarn 或 npm？</li></ol><p>还真有，可以看下这个 =&gt; <a href="https://stackoverflow.com/questions/41076172/force-yarn-install-instead-of-npm-install-for-node-module" target="_blank" rel="noopener noreferrer">Force yarn install instead of npm install for Node module?</a>，推荐使用<a href="https://github.com/pnpm/only-allow" target="_blank" rel="noopener noreferrer">only-allow</a></p><ol start="3"><li>能不能让<code>npm install</code>和<code>yarn install</code>默认锁版本，不更新 lock 文件？</li></ol><p>添加<code>--install.frozen-lockfile true</code>到<code>.yarnrc</code>，可以让<code>--frozen-lockfile</code>成为<code>yarn install</code>的默认参数</p><p><code>npm install</code>没办法做到 yarn 那样</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5总结">5、总结<a href="#5总结" class="hash-link" aria-label="5、总结的直接链接" title="5、总结的直接链接">​</a></h4><p>最后总结下最佳实践流程：</p><p>1、请<strong>务必将 lock 文件提交至远程</strong>，为了自己也为了后面接手的同事（后面同事接手项目跑不起来，翻 git 记录也没有 lock 文件，就会很难受）</p><p>2、从 yarn、npm 中选择一个作为包管理器（建议 yarn），并用<a href="https://github.com/pnpm/only-allow" target="_blank" rel="noopener noreferrer">only-allow</a>进行限制</p><p>3、如果是 yarn，请添加<code>--install.frozen-lockfile true</code>到<code>.yarnrc</code>。npm 可以在团队内约定统一使用<code>npm ci</code></p><p>4、<strong>定期升级版本</strong>，旧版本可能藏雷，定期升级可以在遇到之前排除</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2021/09/03/experience_of_build_wechat_miniapp">小程序开发经验分享</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-09-03T00:00:00.000Z" itemprop="datePublished">2021年9月3日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="小程序开发经验分享">小程序开发经验分享<a href="#小程序开发经验分享" class="hash-link" aria-label="小程序开发经验分享的直接链接" title="小程序开发经验分享的直接链接">​</a></h2><p>这里主要是分享小程序开发时遇到的问题，以及解决方案。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-小程序的缺点">1. 小程序的缺点<a href="#1-小程序的缺点" class="hash-link" aria-label="1. 小程序的缺点的直接链接" title="1. 小程序的缺点的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="11-npm支持不完全">1.1 <code>npm</code>支持不完全<a href="#11-npm支持不完全" class="hash-link" aria-label="11-npm支持不完全的直接链接" title="11-npm支持不完全的直接链接">​</a></h4><p>小程序只支持纯 js 库，而且必须有主入口（需要指定 main），<a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/npm.html" target="_blank" rel="noopener noreferrer">相关文档</a>。</p><p>只要用到 babel 编译的库，都没办法直接引入到小程序里，必须手动引入构建后的包才行，但这样就失去 npm 版本管理的意义。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="12-缺少状态管理">1.2 缺少状态管理<a href="#12-缺少状态管理" class="hash-link" aria-label="1.2 缺少状态管理的直接链接" title="1.2 缺少状态管理的直接链接">​</a></h4><p>这里是指缺少类似于 redux、vuex、mobx 的能力，状态管理是开发大型项目必不可少的需求。</p><p>小程序的 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/storage/wx.getStorage.html" target="_blank" rel="noopener noreferrer">storage</a> 与 localStorage 类似，没有响应变化的能力。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="13-缺少环境变量">1.3 缺少环境变量<a href="#13-缺少环境变量" class="hash-link" aria-label="1.3 缺少环境变量的直接链接" title="1.3 缺少环境变量的直接链接">​</a></h4><p>环境变量主要是用来区分开发、测试、正式这三种，也可以决定一些库是否导入或使用。</p><p>小程序只能区分开发版、体验版、正式版，但把它们对标开发、测试、正式不太好，因为我们可能会在开发者工具里调试开发、测试、正式三种环境。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="14-不会处理cookies">1.4 不会处理<code>cookies</code><a href="#14-不会处理cookies" class="hash-link" aria-label="14-不会处理cookies的直接链接" title="14-不会处理cookies的直接链接">​</a></h4><p>小程序请求时不会自动带上 cookies，返回的 reponse 里虽然有 cookies，但不会自动储存。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="15-入口很多缺少控制层">1.5 入口很多，缺少控制层<a href="#15-入口很多缺少控制层" class="hash-link" aria-label="1.5 入口很多，缺少控制层的直接链接" title="1.5 入口很多，缺少控制层的直接链接">​</a></h4><p>小程序启动时，<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/App.html" target="_blank" rel="noopener noreferrer">App</a> 的生命周期虽然第一个执行，但它不能阻塞其他页面，这意味它不能作为项目里的控制层（比如：登录完成前显示 loading，不显示页面）。</p><p>而且小程序的路由是平铺开来的，如果要做登录拦截，有多少个路由，就要写多少个拦截。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-如何应对">2. 如何应对<a href="#2-如何应对" class="hash-link" aria-label="2. 如何应对的直接链接" title="2. 如何应对的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21-自己打包">2.1 自己打包<a href="#21-自己打包" class="hash-link" aria-label="2.1 自己打包的直接链接" title="2.1 自己打包的直接链接">​</a></h4><p>既然要保留版本管理，又要构建，那我们自己打包输出到<code>miniprogram_npm</code>不就可以了。</p><p>因为只用输出纯 js，所以我们选用 rollup 来打包。</p><p>除此之外，使用<code>yarn workspaces</code>来管理本地依赖（这里我们直接打包到<code>miniprogram_npm</code>，这点可有可无。主要是方便指令控制，以及项目分类）。</p><p>这一步十分重要，是下面两个应对的前提！</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="22-引入-redux">2.2 引入 redux<a href="#22-引入-redux" class="hash-link" aria-label="2.2 引入 redux的直接链接" title="2.2 引入 redux的直接链接">​</a></h4><p>在讲之前，我们先要知道<strong>Component 是可以作为 Page 使用的</strong>，而且<strong>Component 的功能比 Page 更为强大</strong>（Page 属于遗留产物，很鸡肋）。</p><p>引入 redux 就需要 connect，小程序没有现成，所以我们得自行封装。有两种思路，一个是<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Behavior.html" target="_blank" rel="noopener noreferrer">behaviors</a>，另一个是<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/component.html" target="_blank" rel="noopener noreferrer">Component</a>，原理都是劫持生命周期，注入 redux 订阅事件。</p><img loading="lazy" src="/assets/images/37-7c07e595b1a97d5f9d091e61b0d56938.png" width="800" class="img_ev3q"><p>因为我们用到<a href="https://redux-saga.js.org/docs/introduction/GettingStarted" target="_blank" rel="noopener noreferrer">redux-saga</a>做异步处理，里面带有<code>generator function</code>，所以打包时需要引入<code>@babel/plugin-transform-runtime</code>。</p><blockquote><p>babel7 里的<code>@babel/env</code>只提供语法支持，api 则是由<code>runtime</code>提供</p></blockquote><p>注意：redux 里有使用到<code>process.env.NODE_ENV</code>环境变量，这个在下面会一并解决。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23-自定义环境变量">2.3 自定义环境变量<a href="#23-自定义环境变量" class="hash-link" aria-label="2.3 自定义环境变量的直接链接" title="2.3 自定义环境变量的直接链接">​</a></h4><p>打包脚本上挂载环境变量，rollup 打包中统一替换。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//package.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string-property property" style="color:#36acaa">&quot;scripts&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;start&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RUNNER_ENV=dev runner-scripts&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&quot;build&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RUNNER_ENV=prod runner-scripts&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//rollup.config.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&#x27;process.env.NODE_ENV&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">preventAssignment</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来是环境区分，建议打包环境与<a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/account-info/wx.getAccountInfoSync.html" target="_blank" rel="noopener noreferrer">wx.getAccountInfoSync</a>结合使用，下面是我项目里的环境区分。</p><img loading="lazy" src="/assets/images/36-9f7faf35a8a12d16c7011892b9e63646.png" width="400" class="img_ev3q"><p>这样写的好处有两点：</p><ul><li>配置灵活，本地可以调试任意环境</li><li>可以使用测试环境提审，发布后自动转变成正式环境，能与后端同时上线</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="24-封装请求">2.4 封装请求<a href="#24-封装请求" class="hash-link" aria-label="2.4 封装请求的直接链接" title="2.4 封装请求的直接链接">​</a></h4><p>这个好说，小程序 storage 可以持续化储存，从 response 的 header 里取出<code>Set-Cookie</code>，再放进 storage 里这样就实现 cookies 的存储。</p><p>在请求之前，从 storage 获取 cookies，并带在 header 的 Cookies 上即可。</p><p>需要注意的是，正常 cookies 会有<strong>过期时间</strong>，存储时需要把 expires 和 max-age 一起存进去，获取时校验 cookies 是否过期。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="25-维持生命周期">2.5 维持生命周期<a href="#25-维持生命周期" class="hash-link" aria-label="2.5 维持生命周期的直接链接" title="2.5 维持生命周期的直接链接">​</a></h4><p>关于控制层方面，小程序没有解决方案，只能在需要控制的页面上增加控制的逻辑，但我们可以把这一层抽象出来，减少重复代码。</p><p>思路：组件 Layout 控制页面是否渲染，hold（一个 Behavior）通过劫持页面来维持生命周期，直到 Layout 发出通行的信号才执行。通过控制生命周期和页面渲染，达到控制页面的效果，同时组件与 Behavior 都能复用，减少重复率。</p><img loading="lazy" src="/assets/images/38-b1cc9b2c5d79936ae0ff9df2c2de7d2d.png" width="800" class="img_ev3q"><p>BUG：开发时发现页面内组件的生命周期无法维持，需要增加<code>wx:if=&quot;{{!HOLDING}}&quot;</code></p><img loading="lazy" src="/assets/images/39-db52b072da07da3647d43d242474fa70.png" width="400" class="img_ev3q"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-最后">3. 最后<a href="#3-最后" class="hash-link" aria-label="3. 最后的直接链接" title="3. 最后的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="31-关于-eslint">3.1 关于 eslint<a href="#31-关于-eslint" class="hash-link" aria-label="3.1 关于 eslint的直接链接" title="3.1 关于 eslint的直接链接">​</a></h4><img loading="lazy" src="/assets/images/40-1119fbebc746a8a70c019377001d7abb.png" width="400" class="img_ev3q"><p>如果使用 eslint，请指定使用到的微信 api，因为编辑器不知道微信的全局 api 有那些，会直接报错。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="32-canvas-绘制">3.2 canvas 绘制<a href="#32-canvas-绘制" class="hash-link" aria-label="3.2 canvas 绘制的直接链接" title="3.2 canvas 绘制的直接链接">​</a></h4><p>如果手动绘制海报，注意将文案的对齐方式（textBaseline）设置为 middle，y 轴定位加上一半行高即可</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="33-js-支持">3.3 js 支持<a href="#33-js-支持" class="hash-link" aria-label="3.3 js 支持的直接链接" title="3.3 js 支持的直接链接">​</a></h4><p>在开发前最好看下<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/runtime/js-support.html" target="_blank" rel="noopener noreferrer">JavaScript 支持情况</a></p><p>举个例子，其中小程序禁用<code>eval</code>和<code>new Function</code>，<code>@babel/plugin-transform-runtime</code>在编译后会有 Function 代码导致报错，详细见<a href="https://github.com/facebook/regenerator/issues/378" target="_blank" rel="noopener noreferrer">issues</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2021/06/25/better_linear_gradient_background">更好的线性渐变背景</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-25T00:00:00.000Z" itemprop="datePublished">2021年6月25日</time> · <!-- -->阅读需 1 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="更好的线性渐变背景">更好的线性渐变背景<a href="#更好的线性渐变背景" class="hash-link" aria-label="更好的线性渐变背景的直接链接" title="更好的线性渐变背景的直接链接">​</a></h3><p>做渐变背景，比如进度条时，只要把<strong>背景的宽度撑满外部容器</strong>，就能获得更好看的效果</p><div class="language-css codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-css codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token selector class" style="color:#00009f">.inside</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token unit">%</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token unit">px</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">border-radius</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token unit">px</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">background</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">linear-gradient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to right</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hexcode color">#ff3737</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token hexcode color">#3939ff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">background-size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">333.33</span><span class="token unit">%</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> //根据width动态计算出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果图">效果图：<a href="#效果图" class="hash-link" aria-label="效果图：的直接链接" title="效果图：的直接链接">​</a></h5><img loading="lazy" src="/assets/images/35-c7c9549b56bf7aec8c3b88d8c5b4efb1.gif" width="720" class="img_ev3q"><p>线上地址：<a href="https://youniaogu.github.io/react-demo/component" target="_blank" rel="noopener noreferrer">https://youniaogu.github.io/react-demo/component</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2021/02/18/what_is_redux-toolkit">什么是 redux-toolkit</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-18T00:00:00.000Z" itemprop="datePublished">2021年2月18日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-redux-toolkit">什么是 redux-toolkit<a href="#什么是-redux-toolkit" class="hash-link" aria-label="什么是 redux-toolkit的直接链接" title="什么是 redux-toolkit的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-介绍">1. 介绍<a href="#1-介绍" class="hash-link" aria-label="1. 介绍的直接链接" title="1. 介绍的直接链接">​</a></h4><p>redux-toolkit 下面简称为 rtk，是一个结合 redux 工具和语法糖的库，目的是为了解决三个问题</p><ul><li>redux 配置复杂（一般 🤔）</li><li>redux 需要添加一些库配合使用（一般 🤔）</li><li><strong>redux 模版代码过多（重点 💪）</strong></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-createactioncreatereducer">2. createAction、createReducer<a href="#2-createactioncreatereducer" class="hash-link" aria-label="2. createAction、createReducer的直接链接" title="2. createAction、createReducer的直接链接">​</a></h4><blockquote><p>2、3、4 主要是 API 的简单介绍，详细见<a href="https://redux-toolkit.js.org/introduction/getting-started" target="_blank" rel="noopener noreferrer">官网文档</a>，还有与普通 redux 使用的比较</p></blockquote><p><code>createAction</code>类似于<code>actionCreater</code>的形式，两者在传参和返回上有些不同</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> createAction </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@reduxjs/toolkit&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 使用createAction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loadUserInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> createAction</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;user/loadUserInfo&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loadUserInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createAction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;user/loadUserInfo&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">id</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 基于actionCreater</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadUserInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">id</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;LOAD_USER_INFO&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>createReducer</code>用来简化创建 reducer 的函数，内部使用<strong><a href="https://github.com/immerjs/immer" target="_blank" rel="noopener noreferrer">immer</a></strong>大大简化了数据变更的操作</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 正常的userReducer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> initialUserState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;小明&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">userReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state </span><span class="token parameter operator" style="color:#393A34">=</span><span class="token parameter"> initialUserState</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SET_NAME&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SET_AGE&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">age</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SET_SEX&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">sex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 基于`createReducer`简化后的`userReducer`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> initialUserState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;小明&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> userReducer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initialUserState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">builder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SET_NAME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 无需返回新的对象，直接对state进行操作即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SET_AGE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">age</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SET_SEX&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sex</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-createslice">3. createSlice<a href="#3-createslice" class="hash-link" aria-label="3. createSlice的直接链接" title="3. createSlice的直接链接">​</a></h4><p><code>createSlice</code>是由<code>createAction</code>和<code>createReducer</code>组合而成，更进一步简化模版代码</p><p>语法：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSlice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 会添加在action type的前面，[name]/[action type]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 例如：user/GET_USER_INFO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// reducer的初始值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> any</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 在这里通过object（key-value）形式定义你需要的action和reducer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// key也就是action的名称，只能以string的形式定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// value有两种形式：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// (state, action) =&gt; {} //对state进行操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//   reducer: (state, action) =&gt; {},</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//   prepare: (...args) =&gt; { return { payload: any} }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// prepare主要在执行reducer函数前对action传参进行修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 如果不定义prepare，将会默认把第一个参数作为payload传进去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">reducers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">ReducerFunction</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReducerAndPrepareObject</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// extraReducers用来捕抓指定的action，并做出相应动作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 自身的action无法捕抓</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 可以自定义捕抓条件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 如何定义：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 类似与reducers的object（key-value）形式，key定义捕抓的action，value表示捕抓成功后的相应动作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 通过builder的addCase、addMatcher、addDefaultCase进行定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    extraReducers</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">ReducerFunction</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">builder</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ActionReducerMapBuilder</span><span class="token parameter operator" style="color:#393A34">&lt;</span><span class="token parameter maybe-class-name">State</span><span class="token parameter operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>举个 🌰：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">timeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">ms</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">resolve</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resolve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getUserInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> createAsyncThunk</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> sex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;user/getUserInfo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">payload</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> thunkApi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">timeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 请求接口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;小明&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">sex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 返回结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loadOrderList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> createAsyncThunk</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">list</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">orderId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">price</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">page</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">total</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;order/loadOrderList&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">payload</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> thunkApi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">timeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 请求接口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">list</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">orderId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">price</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">orderId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">price</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1300</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">orderId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">price</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">page</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">total</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 返回结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> userSlice </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createSlice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;user&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">loadStatus</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">sex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">reducers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&#x27;getUserInfo/pending&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">loadStatus</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&#x27;getUserInfo/fulfilled&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">payload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">loadStatus</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sex</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">age</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> age</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&#x27;getUserInfo/rejected&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">loadStatus</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">extraReducers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">builder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loadOrderList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">pending</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loadOrderList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">fulfilled</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">loadOrderList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rejected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-createasyncthunk">4. createAsyncThunk<a href="#4-createasyncthunk" class="hash-link" aria-label="4. createAsyncThunk的直接链接" title="4. createAsyncThunk的直接链接">​</a></h4><p><code>createAsyncThunk</code>是基于<code>redux-thunk</code>封装的 api，用来处理异步逻辑，创建出来的<code>type</code>有三种状态</p><p>例如定义的 type 为<code>user/getUserInfo</code>：</p><table><thead><tr><th>status</th><th>type</th></tr></thead><tbody><tr><td>pending</td><td>user/getUserInfo/pending</td></tr><tr><td>fulfilled</td><td>user/getUserInfo/fulfilled</td></tr><tr><td>rejected</td><td>user/getUserInfo/rejected</td></tr></tbody></table><ol><li><p>在触发<code>action</code>的时候，就会进入<strong>pending</strong>状态</p></li><li><p>正常<code>return</code>会进入<strong>fulfilled</strong>状态</p></li><li><p>而使用<code>thunkAPI.rejectWithValue</code>返回则会进入<strong>rejected</strong>状态（<a href="https://redux-toolkit-cn.netlify.app/api/createAsyncThunk#payloadcreator" target="_blank" rel="noopener noreferrer">相关 api</a>）</p></li></ol><img loading="lazy" src="/assets/images/34-286f968a9ee97bc6bf613690ab620055.png" width="700" alt="34.png" class="img_ev3q"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5createentityadapter">5、createEntityAdapter<a href="#5createentityadapter" class="hash-link" aria-label="5、createEntityAdapter的直接链接" title="5、createEntityAdapter的直接链接">​</a></h4><p><code>createEntityAdapter</code>可以理解为封装 CRUD（增删查改）后的<code>reducer</code>与<code>selector</code>函数</p><p>熟练掌握后可以加快列表、字典等业务逻辑的开发速度，不强制要求学习</p><p>封装程度较高，建议查阅<a href="https://redux-toolkit-cn.netlify.app/api/createEntityAdapter" target="_blank" rel="noopener noreferrer">相关 API 文档</a>学习</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6实践-qa">6、实践 QA<a href="#6实践-qa" class="hash-link" aria-label="6、实践 QA的直接链接" title="6、实践 QA的直接链接">​</a></h4><p>因为一些原因，没能在实际项目中实践运用，但我写了两个 codesandbox，它们实现了相同的功能，可以对比一下差异</p><ul><li><a href="https://codesandbox.io/s/example-rtk-sdnjk" target="_blank" rel="noopener noreferrer">redux-toolkit</a></li><li><a href="https://codesandbox.io/s/example-redux-9x9wm" target="_blank" rel="noopener noreferrer">redux</a></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="7总结">7、总结<a href="#7总结" class="hash-link" aria-label="7、总结的直接链接" title="7、总结的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="优点">优点：<a href="#优点" class="hash-link" aria-label="优点：的直接链接" title="优点：的直接链接">​</a></h5><ul><li>使用<code>slice</code>代替<code>action、reducer</code>，减少文件<strong>碎片化</strong></li><li>使用<code>immer</code>，大大<strong>简化</strong><code>state</code>的操作</li><li>对于数据操作频繁的项目来说，<strong>熟练掌握</strong><code>createEntityAdapter</code>后可以<strong>提高业务逻辑开发速度</strong></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="优点-1">优点：<a href="#优点-1" class="hash-link" aria-label="优点：的直接链接" title="优点：的直接链接">​</a></h5><ul><li>存在<strong>学习成本</strong>，即使熟练运用<code>redux</code>，也需要一定时间上手</li><li><code>slice</code>复杂度比<code>action、reducer</code>高</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="如果说redux是最原始的加减法那rtk就是乘除法它能带来的收益是远远大于付出的">如果说<code>redux</code>是最原始的加减法，那<code>rtk</code>就是乘除法，它能带来的收益是远远大于付出的<a href="#如果说redux是最原始的加减法那rtk就是乘除法它能带来的收益是远远大于付出的" class="hash-link" aria-label="如果说redux是最原始的加减法那rtk就是乘除法它能带来的收益是远远大于付出的的直接链接" title="如果说redux是最原始的加减法那rtk就是乘除法它能带来的收益是远远大于付出的的直接链接">​</a></h5></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2020/12/21/learn_about_class_through_babel">通过 babel 看 class</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-12-21T00:00:00.000Z" itemprop="datePublished">2020年12月21日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="通过-babel-看-class">通过 babel 看 class<a href="#通过-babel-看-class" class="hash-link" aria-label="通过 babel 看 class的直接链接" title="通过 babel 看 class的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-前言">1. 前言<a href="#1-前言" class="hash-link" aria-label="1. 前言的直接链接" title="1. 前言的直接链接">​</a></h4><p>最近在写单元测试，在使用<code>jest.spyOn</code>测试生命周期方法和函数时，发现箭头函数无法使用下列代码进行测试</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//Error: Cannot spy the handleCardClick property because it is not a function; undefined given instead</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> handleCardClick </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">spyOn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">App</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;handleCardClick&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> wrapper </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">shallow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>报错提示说明<code>App.prototype.handleCardClick</code>为<code>undefined</code>，这就有意思了</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-编译简化">2. 编译简化<a href="#2-编译简化" class="hash-link" aria-label="2. 编译简化的直接链接" title="2. 编译简化的直接链接">​</a></h4><p>通过<a href="https://babeljs.io/repl/#?browsers=&amp;build=&amp;builtIns=false&amp;spec=false&amp;loose=false&amp;code_lz=FBA&amp;debug=false&amp;forceAllTransforms=false&amp;shippedProposals=false&amp;circleciRepo=&amp;evaluate=true&amp;fileSize=false&amp;timeTravel=false&amp;sourceType=module&amp;lineWrap=false&amp;presets=es2015%2Creact%2Cstage-2&amp;prettier=false&amp;targets=&amp;version=7.12.9&amp;externalPlugins=" target="_blank" rel="noopener noreferrer">babel tranfer online</a>编译，发现箭头函数与普通函数处理有点不同</p><blockquote><p>为了易于理解，以下编译后代码经过简化，如果对非简化部分感兴趣，建议自行编译查看</p></blockquote><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">handleCardClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>↓↓↓ 相当于 ↓↓↓</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">App</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">handleCardClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">App</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">fn</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，函数<code>fn</code>绑定在<code>App.prototype</code>上，而箭头函数<code>handleCardClick</code>绑定在<code>App</code>的实例上</p><p>问题解决了，但秉持着学习的心态，我把<code>class</code>里大部分定义变量和函数的情况都列举了出来</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v2&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v2&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v3&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fn1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">fn2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fn3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">fn4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>↓↓↓ 相当于 ↓↓↓</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">App</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v2&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v3&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">fn2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">App</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">fn1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">App</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">fn3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">App</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v2&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">App</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">fn4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有一点需要注意，<code>constructor</code>在<code>class</code>里定义的上下位置对编译结果无影响</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面两个类编译后结果一致</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">App</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">v1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fake v1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>总结：</p><ul><li>具有 static 属性的变量和函数会直接定义在构造函数上，优先级最高</li><li>箭头函数在构造函数内，会定义在实例上面</li><li>constructor 的定义会覆盖类上的定义</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-继承">3. 继承<a href="#3-继承" class="hash-link" aria-label="3. 继承的直接链接" title="3. 继承的直接链接">​</a></h4><p>最后再研究下继承以及<code>super</code>编译后的结果</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">B</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name" style="color:#d73a49">A</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">A</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">_A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//super相当于new关键字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">super</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token maybe-class-name">Super</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _B</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__proto__</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">Super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      result </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">_typeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;object&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;function&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_B</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//相当于new B(...arguments)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//继承_A的prototype，并将原型指向_A</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">_B</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prototype</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token class-name">_A</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prototype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">constructor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> _B</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  _B</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__proto__</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _A</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> _B</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2020/11/16/record_a_question_of_react">记一个 react 问题</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-11-16T00:00:00.000Z" itemprop="datePublished">2020年11月16日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="记一个-react-问题">记一个 react 问题<a href="#记一个-react-问题" class="hash-link" aria-label="记一个 react 问题的直接链接" title="记一个 react 问题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-前言">1. 前言<a href="#1-前言" class="hash-link" aria-label="1. 前言的直接链接" title="1. 前言的直接链接">​</a></h4><p>前几天看到一篇文章：<a href="https://juejin.im/post/6889247428797530126" target="_blank" rel="noopener noreferrer">我在大厂写 React，学到了什么？性能优化篇</a>，文章最开始提到了神奇的<code>children</code>，讲诉使用<code>children</code>避免了不必要的渲染，蛮有意思的。而这篇文章，主要是分享我对文章中问题的理解，同时梳理了关于 react 渲染机制的知识</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-问题是什么">2. 问题是什么？<a href="#2-问题是什么" class="hash-link" aria-label="2. 问题是什么？的直接链接" title="2. 问题是什么？的直接链接">​</a></h4><p>文中<code>ChildNonTheme</code>里没有依赖 context，但修改 context 的时候，为什么会触发渲染？</p><p>因为父节点发生改变时(state、props、context)，子节点无论怎么样都会重新渲染，就是这么简单</p><p>如果需要追根溯源的话，根本原因是 react diff 算法在比较新旧节点的时候，如果父节点发生改变，将会直接替换整个节点，而不会对子节点进行比较。所以即使<code>ChildNonTheme</code>里的状态没发生改变，也会重新渲染</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-怎么解决">3. 怎么解决？<a href="#3-怎么解决" class="hash-link" aria-label="3. 怎么解决？的直接链接" title="3. 怎么解决？的直接链接">​</a></h4><p>文中使用<code>children</code>方法之所以能够解决问题，个人认为<code>ChildNonTheme</code>此时并不属于<code>ThemeApp</code>的子节点，而是属于<code>App</code>，所以<code>ThemeApp</code>节点改变时，并不能触发<code>ChildNonTheme</code>的渲染（<strong>单纯个人猜测，如有更好解释或发现错误，欢迎指出</strong>）</p><p>除了<code>children</code>外，还可以使用<code>React.memo</code>，对应 Component 写法是<code>React.PureComponent</code>，这样不需要改变代码结构，更加方便</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/2020/11/09/practice_experience_of_typescript">typescript 实践心得</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-11-09T00:00:00.000Z" itemprop="datePublished">2020年11月9日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/youniaogu.png" alt="youniaogu"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">youniaogu</span></a></div><small class="avatar__subtitle" itemprop="description">作者</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typescript-实践心得">typescript 实践心得<a href="#typescript-实践心得" class="hash-link" aria-label="typescript 实践心得的直接链接" title="typescript 实践心得的直接链接">​</a></h3><p>先说下总结：</p><blockquote><ol><li><p>typescript 的静态检查能够规避很多错误，越用越香。</p></li><li><p>类型检查需要环环相扣，如果运用不当，将会成为如梗在喉般的存在</p></li><li><p>redux 的单一数据源思想与 typescript 十分搭配</p></li></ol></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-前言">1. 前言<a href="#1-前言" class="hash-link" aria-label="1. 前言的直接链接" title="1. 前言的直接链接">​</a></h4><p>几个月前我开始学习 typescript，并将其运用到项目中，这篇文章主要用来记录实战过程中一些心得，主要围绕 redux 状态与 typescript 来讲述</p><p>tips：在开发项目前，建议先查阅去相关库文档（比如：<a href="https://redux.js.org/recipes/usage-with-typescript" target="_blank" rel="noopener noreferrer">redux</a>），可能会有一些关于 typescript 的教程</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-项目搭建">2. 项目搭建<a href="#2-项目搭建" class="hash-link" aria-label="2. 项目搭建的直接链接" title="2. 项目搭建的直接链接">​</a></h4><p>使用<code>cra</code>搭建，因为开发进度紧急，没有多余的时间来研究<code>webpack</code>和<code>babel</code>配置（而且我相信<code>cra</code>做的肯定比我好）</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-connect-和-typescript">3. connect 和 typescript<a href="#3-connect-和-typescript" class="hash-link" aria-label="3. connect 和 typescript的直接链接" title="3. connect 和 typescript的直接链接">​</a></h4><p>在 typescript 中，<code>react.component</code>需要定义<code>props</code>和<code>state</code>的类型，所以在使用<code>connect</code>的情况下，需要对传递的<code>props</code>进行类型定义</p><p><code>mapStateToProps</code>为函数类型，<code>mapDispatchToProps</code>为对象类型，所以最好的办法是使用范型工具<code>ReturnType</code>和<code>typeof</code></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type </span><span class="token maybe-class-name">PropsTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> mapStateToProps</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> mapDispatchToProps </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">mapStateToProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">state</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTypes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">app</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> mapDispatchToProps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> launch </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">component</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">PropsTypes</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面例子的<code>RootTypes</code>指<code>redux</code>中整个<code>state</code>的类型，下面就来介绍如何获取它</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-reducer-和-typescript">4. reducer 和 typescript<a href="#4-reducer-和-typescript" class="hash-link" aria-label="4. reducer 和 typescript的直接链接" title="4. reducer 和 typescript的直接链接">​</a></h4><p><code>reducer</code>作为纯函数，用<code>ReturnType</code>很简单就可以获得返回的类型</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> combineReducers </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;redux&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">launchCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">error</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">Error</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">|</span><span class="token parameter"> </span><span class="token parameter keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH_COMPLETION&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">appReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state </span><span class="token parameter operator" style="color:#393A34">=</span><span class="token parameter"> initialState</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> initialState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH_COMPLETION&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rootReducer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">combineReducers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> appReducer </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> type </span><span class="token maybe-class-name">RootTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> rootReducer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> rootReducer</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意<code>appReducer</code>方法必须定义返回的类型，如下</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">appReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state </span><span class="token parameter operator" style="color:#393A34">=</span><span class="token parameter"> initialState</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> initialState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>如何不定义，返回的类型将会是<code>never</code>!</strong></p><p>上面的<code>reducer</code>虽然能返回正确的<code>RootTypes</code>，<strong>但<code>action</code>还没有定义</strong>，<code>action</code>的类型为<code>any</code>，这样<code>RootTypes</code>将毫无意义，因为<code>case</code>里可以随意修改返回的<code>state</code>，<strong>所以为<code>action</code>添加类型尤为重要</strong></p><p><code>action creator</code>为函数类型，所以只需要将<code>action creator</code>返回的类型导出，然后导入到<code>reducer</code>里，为<code>action</code>提供类型</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">launchCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">appReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">state </span><span class="token parameter operator" style="color:#393A34">=</span><span class="token parameter"> initialState</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> initialState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH_COMPLETION&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> error </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> action </span><span class="token keyword module" style="color:#00009f">as</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> launchCompletion</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样子可行，但如果<code>case</code>数量多起来，就需要导入多个类型，多次为<code>action</code>提供类型，偏麻烦。这里可以使用 typescript<a href="https://jkchao.github.io/typescript-book-chinese/typings/discrominatedUnion.html#%E8%AF%A6%E7%BB%86%E7%9A%84%E6%A3%80%E6%9F%A5" target="_blank" rel="noopener noreferrer">辨析联合类型</a>的特性优化一下</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">launchCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">error</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">Error</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">|</span><span class="token parameter"> </span><span class="token parameter keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadUserList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">page</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> number</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter literal-property property" style="color:#36acaa">pageSize</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadUserListCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">error</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">Error</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">|</span><span class="token parameter"> </span><span class="token parameter keyword nil" style="color:#00009f">undefined</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter literal-property property" style="color:#36acaa">data</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter punctuation" style="color:#393A34">[</span><span class="token parameter">key</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> string</span><span class="token parameter punctuation" style="color:#393A34">]</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> any</span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> type </span><span class="token maybe-class-name">ActionTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> launch</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> launchCompletion</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> loadUserList</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> loadUserListCompletion</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">appReducer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">state</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">=</span><span class="token parameter"> initialState</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter literal-property property" style="color:#36acaa">action</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ActionTypes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> initialState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAUNCH_COMPLETION&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LOAD_USER_LIST&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LOAD_USER_LIST_COMPLETION&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>只需要引入<code>ActionTypes</code>，并为<code>action</code>添加类型，typescript 会根据<code>action.type</code>推断出当前 action 的类型</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-saga-和-typescript">5. saga 和 typescript<a href="#5-saga-和-typescript" class="hash-link" aria-label="5. saga 和 typescript的直接链接" title="5. saga 和 typescript的直接链接">​</a></h4><p>saga 需要进行类型定义的主要有两点</p><ul><li>第一：请求完接口后返回的数据</li><li>第二：使用<code>select</code>返回的<code>state</code></li></ul><p>接口返回的数据和格式是不可控的，如果对其进行类型定义将会花费大量精力，不可取，建议<code>any</code>带过。重点放在第二点上</p><p><code>select</code>的返回总是<code>any</code>，即使<code>selector</code>定义了返回的类型，详细可以看：<a href="https://github.com/redux-saga/redux-saga/issues/970" target="_blank" rel="noopener noreferrer">issues</a></p><p>比较好的解决方法主要有两种</p><ul><li>第一种：将<code>selector</code>拿出来，使用<code>ReturnType</code>为返回结果进行定义</li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">selector</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">state</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTypes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">app</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> selector</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>逻辑和最初一样</strong>，写法上绕了一下</p><ul><li>第二种：利用<code>yield select()</code>等同于<code>getState()</code>的特点，将<code>select</code>的返回作为传参传入<code>selector</code>中</li></ul><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">state</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTypes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>写法简单，但与最初的逻辑有出入</strong>，比如进行测试时，需要传入整个 state</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-全局变量">6. 全局变量<a href="#6-全局变量" class="hash-link" aria-label="6. 全局变量的直接链接" title="6. 全局变量的直接链接">​</a></h4><p><code>ActionTypes</code>和<code>RootTypes</code>都是唯一的，只需要在全局定义这两个类型，就可以减少导入代码花费的时间</p><p>step 1. 确认<code>tsconfig.json</code>里的配置，把全局配置的<code>.d.ts</code>文件放在编译的范围内即可</p><p>step 2. 写入全局类型</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//actions.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> type </span><span class="token maybe-class-name">ActionTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> launch</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> launchCompletion</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> loadUserList</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> loadUserListCompletion</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//reducers.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> type </span><span class="token maybe-class-name">RootTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReturnType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> rootReducer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">default</span><span class="token plain"> rootReducer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// global.d.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">declare type </span><span class="token maybe-class-name">RootTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;reducers&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">RootTypes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">declare type </span><span class="token maybe-class-name">ActionTypes</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;actions&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">ActionTypes</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>step 3. 需要注意的点</p><p>第一，import 导入是在 typescript2.9 加入的，并且只能导入类型</p><p>第二，在添加全局类型后，有可能会出现编译器报错，而编译通过的问题(见下图)，重启 vscode 即可解决</p><img loading="lazy" src="/assets/images/33-dbc2fae31e0f93b8d9c2c382ed638185.png" width="600" alt="33.png" class="img_ev3q"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-写在最后">7. 写在最后<a href="#7-写在最后" class="hash-link" aria-label="7. 写在最后的直接链接" title="7. 写在最后的直接链接">​</a></h4><p>最开始使用 typescript，新手上路，不知道如何使用范型，写了很多重复的类型定义，费时又费力。而且修改 redux 里的 state 定义，需要修改好几处的 props，是真的很难受，<strong>感觉很不值得</strong></p><p>后面慢慢学会如何运用范型，结合 redux 单一数据源设计，数据至上而下传递，类型也可以随着数据至上而下传递，不用在各个地方定义类型，<strong>用更少的代码获得更多的类型定义，typescript 慢慢香了起来</strong></p><p>typescript 是 javascript 的超集，语法上学习起来很简单，但要想有个好的体验和实践，没有想象中那么简单，就跟画马一样</p><img loading="lazy" src="/assets/images/32-9017f3673178f5260f09f81ab8e95baa.png" width="300" alt="32.png" class="img_ev3q"><p>希望这篇文章对你有所帮助，谢谢！</p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li><li class="footer__item"><a href="https://github.com/youniaogu" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 youniaogu</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7de11c5b.js"></script>
<script src="/assets/js/main.501984e4.js"></script>
</body>
</html>